#!/bin/dash
set -e
# for systemd --user
exec >&2

# Ever since I updated Ubuntu to 23.something,
# Fcitx5's language switching became unpredictable.
# On Ubuntu 21.something, it predictably switched me back to the previous language (group).
# After the update, it occasionally does that but frequently switches me a random language.
# This script pins Fcitx5 on a single-item group history, so things become predictable again.
# It also fixes the ESC closing the Browse window in Anki problem

FILE=~/opt/fcitxswitchlastgroup
DEST='--dest=org.fcitx.Fcitx5'
PKG='/controller'
BASE='org.fcitx.Fcitx.Controller1'

>> "$FILE"
LAST="$(cat "$FILE")"
NEXT='Group 1'
echo 'Saved was '"$LAST"
if [ -z "$LAST" ]; then
 LAST='Q' # Default to English-QWERTY
fi

REPLY="$(dbus-send --print-reply=literal "$DEST" "$PKG" "$BASE".CurrentInputMethodGroup | tail -n 1 | xargs echo -n)"
echo 'Active is '"$REPLY"

if echo "$REPLY" | grep -q 'Group 1'; then
 NEXT="$LAST"
 echo 'Activating saved '"$LAST"
elif [ "$REPLY" != "$LAST" ]; then
 echo -n $REPLY > "$FILE"
 echo 'Saving deactivating '"$REPLY"
else
 echo 'Deactivating same '"$REPLY"
fi

# Somehow Fcitx5 not liking signals necessitates --type or --print-reply to force Fcitx5 the type method_call.
dbus-send --type=method_call "$DEST" "$PKG" "$BASE".SwitchInputMethodGroup string:"$NEXT"

# Avoid systemd --user no such PID warnings
sleep 1
