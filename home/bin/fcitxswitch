#!/bin/dash
set -e
# for systemd --user
exec >&2

# Ever since I updated Ubuntu to 23.something,
# Fcitx5's language switching became unpredictable.
# On Ubuntu 21.something, it predictably switched me back to the previous language (group).
# After the update, it occasionally does that but frequently switches me a random language.
# This script pins Fcitx5 on a single-item group history, so things become predictable again.
# It also fixes the ESC closing the Browse window in Anki problem

FILE=~/opt/fcitxswitchlastgroup
DEST='--dest=org.fcitx.Fcitx5'
PKG='/controller'
BASE='org.fcitx.Fcitx.Controller1'

>> "$FILE"
LAST="$(cat "$FILE")"
NEXT='Group 1'
echo 'Saved was '"$LAST"
if [ -z "$LAST" ]; then
 LAST='Q' # Default to English-QWERTY
fi

REPLY="$(dbus-send --print-reply=literal "$DEST" "$PKG" "$BASE".CurrentInputMethodGroup | tail -n 1 | xargs echo -n)"
echo 'Active is '"$REPLY"

if echo "$REPLY" | grep -q 'Group 1'; then
 NEXT="$LAST"
 echo 'Activating saved '"$LAST"
elif [ "$REPLY" != "$LAST" ]; then
 echo -n $REPLY > "$FILE"
 echo 'Saving deactivating '"$REPLY"
else
 echo 'Deactivating same '"$REPLY"
fi

# Backport https://github.com/fcitx/fcitx5/pull/1467
inotifywait -e moved_to --include kxkbrc ~/.config && busctl emit --user /kxkbrc org.kde.kconfig.notify ConfigChanged a{saay} 1 Layout 4 10 76 97 121 111 117 116 76 105 115 116 12 68 105 115 112 108 97 121 78 97 109 101 115 11 86 97 114 105 97 110 116 76 105 115 116 3 85 115 101 &

# Somehow Fcitx5 not liking signals necessitates --type or --print-reply to force Fcitx5 the type method_call.
dbus-send --type=method_call "$DEST" "$PKG" "$BASE".SwitchInputMethodGroup string:"$NEXT"

# Avoid systemd --user no such PID warnings
sleep 1
